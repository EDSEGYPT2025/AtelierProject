@page
@model AtelierProject.Pages.Reports.SafeModel
@using AtelierProject.Models
@{
    ViewData["Title"] = "تقرير الخزينة";
    var reportTitle = "كشف حساب حركة الخزينة";
    var branchTitle = Model.SelectedBranchId.HasValue ? "فرع محدد" : "كافة الفروع";
}

<style>
    /* ========================================= */
    /* 👑 تنسيقات الثيم الملكي (للعرض على الشاشة) */
    /* ========================================= */

    .page-title {
        font-family: 'Playfair Display', serif;
        color: #1e293b;
        font-weight: 700;
    }

    /* كروت الإحصائيات العلوية */
    .stat-card {
        border: none;
        border-radius: 15px;
        padding: 20px;
        color: #fff;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s;
    }

        .stat-card:hover {
            transform: translateY(-5px);
        }

    .bg-revenue {
        background: linear-gradient(135deg, #10b981, #059669);
    }
    /* أخضر للإيراد */
    .bg-expense {
        background: linear-gradient(135deg, #ef4444, #b91c1c);
    }
    /* أحمر للمصروف */
    .bg-net {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    }
    /* أزرق للصافي */
    .bg-insurance {
        background: linear-gradient(135deg, #6366f1, #4338ca);
    }
    /* بنفسجي للتأمين */

    .stat-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 3rem;
        opacity: 0.2;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 800;
        margin-bottom: 0;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* كارت الفلتر */
    .filter-card {
        border: none;
        border-radius: 15px;
        background: #fff;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        margin-bottom: 25px;
    }

    .form-control, .form-select {
        border-radius: 10px;
        padding: 10px 15px;
        border: 1px solid #e2e8f0;
    }

        .form-control:focus, .form-select:focus {
            border-color: #c5a059;
            box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.1);
        }

    /* الجدول */
    .luxury-table {
        border-collapse: separate;
        border-spacing: 0 5px;
    }

        .luxury-table thead th {
            border: none;
            color: #64748b;
            font-weight: 600;
            padding: 15px;
            font-size: 0.85rem;
            background-color: #f8fafc;
            text-transform: uppercase;
        }

        .luxury-table tbody tr {
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: 0.2s;
        }

        .luxury-table td {
            border: none;
            padding: 15px;
            vertical-align: middle;
            color: #334155;
        }

            .luxury-table td:first-child {
                border-radius: 10px 0 0 10px;
            }

            .luxury-table td:last-child {
                border-radius: 0 10px 10px 0;
            }

    /* ألوان المبالغ */
    .text-income {
        color: #059669;
        font-weight: bold;
    }

    .text-expense {
        color: #dc2626;
        font-weight: bold;
    }

    .text-insurance-in {
        color: #2563eb;
        font-weight: bold;
    }

    .text-insurance-out {
        color: #4b5563;
        font-weight: bold;
    }

    /* ========================================= */
    /* 🖨️ إعدادات الطباعة (A4 Standard) */
    /* ========================================= */
    @@media print {
        #sidebar-wrapper, .navbar, .btn, form, .no-print, .page-title-icon {
            display: none !important;
        }

        body {
            background-color: #fff !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 10pt;
            color: #000;
            padding: 0;
            margin: 0;
        }

        .container-fluid {
            width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        /* ترويسة الطباعة */
        .print-header {
            display: flex !important;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        /* جدول الطباعة */
        .luxury-table {
            border-collapse: collapse !important;
            border-spacing: 0 !important;
            box-shadow: none !important;
        }

            .luxury-table th {
                background-color: #f0f0f0 !important;
                border: 1px solid #000 !important;
                color: #000 !important;
                padding: 5px !important;
            }

            .luxury-table td {
                border: 1px solid #000 !important;
                padding: 5px !important;
                color: #000 !important;
                border-radius: 0 !important;
            }

            .luxury-table tr {
                box-shadow: none !important;
            }
        /* ملخص الطباعة */
        .print-summary-box {
            display: block !important;
            border: 1px solid #000;
            padding: 10px;
            margin-bottom: 20px;
            page-break-inside: avoid;
        }
        /* إخفاء الكروت الملونة واستبدالها بالجدول الملخص */
        .stats-row {
            display: none !important;
        }
        /* التوقيعات */
        .signatures {
            display: flex !important;
            justify-content: space-between;
            margin-top: 50px;
            page-break-inside: avoid;
        }

        .signature-box {
            width: 30%;
            border-top: 1px solid #000;
            text-align: center;
            padding-top: 5px;
        }
    }

    /* إخفاء عناصر الطباعة في الشاشة */
    .print-header, .print-summary-box, .signatures {
        display: none;
    }
</style>

<div class="container-fluid py-4">

    <div class="print-header">
        <div class="text-end">
            <h2 class="m-0 fw-bold">Atelier System</h2>
            <p class="m-0 small">تقرير مالي رسمي</p>
        </div>
        <div class="text-center">
            <h3 class="fw-bold text-decoration-underline">@reportTitle</h3>
            <p class="m-0 small">عن الفترة من: <strong>@Model.FromDate.ToString("yyyy-MM-dd")</strong> إلى: <strong>@Model.ToDate.ToString("yyyy-MM-dd")</strong></p>
        </div>
        <div class="text-start">
            <p class="m-0 small">الفرع: <strong>@branchTitle</strong></p>
            <p class="m-0 small">تاريخ الطباعة: @DateTime.Now.ToString("yyyy-MM-dd HH:mm")</p>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <div>
            <h3 class="page-title mb-1"><i class="fa-solid fa-vault text-warning me-2 page-title-icon"></i> حركة الخزينة</h3>
            <p class="text-muted small mb-0">تقرير شامل للتدفقات النقدية والعمليات المالية</p>
        </div>
        <button onclick="window.print()" class="btn btn-dark shadow-sm px-4">
            <i class="fa-solid fa-print me-2"></i> طباعة التقرير
        </button>
    </div>

    <div class="filter-card p-4 no-print">
        <form method="get" class="row g-3 align-items-end">
            @if (Model.IsGeneralManager)
            {
                <div class="col-md-2">
                    <label class="form-label fw-bold text-muted small">الفرع</label>
                    <select asp-for="SelectedBranchId" class="form-select" asp-items="ViewBag.BranchId" onchange="this.form.submit()">
                        <option value="">-- كل الفروع --</option>
                    </select>
                </div>
            }

            <div class="col-md-2">
                <label class="form-label fw-bold text-muted small">القسم</label>
                <select asp-for="SelectedDepartment" class="form-select" asp-items="Html.GetEnumSelectList<DepartmentType>()" onchange="this.form.submit()">
                    <option value="">-- كل الأقسام --</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold text-muted small">الموظف المسؤول</label>
                <select asp-for="SelectedUserId" class="form-select" asp-items="ViewBag.UserId" onchange="this.form.submit()">
                    <option value="">-- كل المستخدمين --</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-bold text-muted small">من تاريخ</label>
                <input asp-for="FromDate" type="date" class="form-control" />
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold text-muted small">إلى تاريخ</label>
                <input asp-for="ToDate" type="date" class="form-control" />
            </div>

            <div class="col-md-1">
                <button type="submit" class="btn btn-primary w-100"><i class="fa-solid fa-filter"></i></button>
            </div>
        </form>
    </div>

    <div class="row g-3 mb-4 stats-row">
        <div class="col-md-3">
            <div class="stat-card bg-revenue">
                <i class="fa-solid fa-sack-dollar stat-icon"></i>
                <div class="stat-label">إجمالي الإيرادات</div>
                <div class="stat-value">@Model.PeriodRevenue.ToString("N0") <small class="fs-6">ج.م</small></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-expense">
                <i class="fa-solid fa-file-invoice-dollar stat-icon"></i>
                <div class="stat-label">إجمالي المصروفات</div>
                <div class="stat-value">@Model.PeriodExpense.ToString("N0") <small class="fs-6">ج.م</small></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-insurance">
                <i class="fa-solid fa-shield-halved stat-icon"></i>
                <div class="stat-label">صافي التأمين</div>
                <div class="stat-value">@((Model.PeriodInsuranceIn - Model.PeriodInsuranceOut).ToString("N0")) <small class="fs-6">ج.م</small></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-net">
                <i class="fa-solid fa-scale-balanced stat-icon"></i>
                <div class="stat-label">صافي الحركة (Net Flow)</div>
                <div class="stat-value">@Model.PeriodNetFlow.ToString("N0") <small class="fs-6">ج.م</small></div>
            </div>
        </div>
    </div>

    <div class="print-summary-box">
        <h5 class="fw-bold mb-2 border-bottom pb-1">ملخص الفترة المالية</h5>
        <table style="width:100%; border:none;">
            <tr>
                <td style="border:none; padding:5px;"><strong>إيرادات:</strong> @Model.PeriodRevenue.ToString("N0") ج.م</td>
                <td style="border:none; padding:5px;"><strong>مصروفات:</strong> (@Model.PeriodExpense.ToString("N0")) ج.م</td>
                <td style="border:none; padding:5px;"><strong>تأمين (محصل - مسترد):</strong> @((Model.PeriodInsuranceIn - Model.PeriodInsuranceOut).ToString("N0")) ج.م</td>
                <td style="border:none; padding:5px; font-size:1.1rem;"><strong>الصافي:</strong> @Model.PeriodNetFlow.ToString("N0") ج.م</td>
            </tr>
        </table>
    </div>

    <div class="table-responsive">
        <table class="table luxury-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>التاريخ</th>
                    @if (Model.IsGeneralManager)
                    {
                        <th>الفرع</th>
}
                    <th>نوع الحركة</th>
                    <th>القسم</th>
                    <th>البيان / الوصف</th>
                    <th>المستخدم</th>
                    <th class="text-end">المبلغ</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Transactions.Count == 0)
                {
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">لا توجد حركات مالية في هذه الفترة.</td>
                    </tr>
                }
                else
                {
                    @foreach (var item in Model.Transactions)
                    {
                        <tr>
                            <td>@item.Id</td>

                            <td>
                                <div class="fw-bold">@item.TransactionDate.ToString("yyyy-MM-dd")</div>
                                <small class="text-muted no-print">@item.TransactionDate.ToString("hh:mm tt")</small>
                            </td>

                            @if (Model.IsGeneralManager)
                            {
                                <td>@item.Branch?.Name</td>
                            }

                            <td>
                                @switch (item.Type)
                                {
                                    case TransactionType.Income:
                                        <span class="badge bg-success bg-opacity-10 text-success border border-success px-2 no-print">إيراد</span>
                                        <span class="d-none d-print-inline">إيراد</span>
                                        break;
                                    case TransactionType.Expense:
                                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger px-2 no-print">مصروف</span>
                                        <span class="d-none d-print-inline">مصروف</span>
                                        break;
                                    case TransactionType.InsuranceIn:
                                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary px-2 no-print">تأمين (قبض)</span>
                                        <span class="d-none d-print-inline">تأمين (قبض)</span>
                                        break;
                                    case TransactionType.InsuranceOut:
                                        <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary px-2 no-print">تأمين (رد)</span>
                                        <span class="d-none d-print-inline">تأمين (رد)</span>
                                        break;
                                }
                            </td>

                            <td>
                                @switch (item.Department)
                                {
                                    case DepartmentType.Men:<span>رجالي</span> break;
                                    case DepartmentType.Women: <span>حريمي</span> break;
                                    case DepartmentType.BeautySalon: <span>كوافير</span>break;
                                }
                            </td>

                            <td>@item.Description</td>

                            <td>
                                @{
                                    string userName = "System";
                                    if (item.CreatedByUserId != null && Model.UserNames.ContainsKey(item.CreatedByUserId))
                                    {
                                        userName = Model.UserNames[item.CreatedByUserId];
                                    }
                                }
                                <span class="small text-muted">@userName</span>
                            </td>

                            <td class="text-end fw-bold">
                                @if (item.Type == TransactionType.Expense || item.Type == TransactionType.InsuranceOut)
                                {
                                    <span class="text-expense">(@item.Amount.ToString("N0"))</span>
                                }
                                else
                                {
                                    <span class="text-income">@item.Amount.ToString("N0")</span>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="signatures">
        <div class="signature-box">
            <p class="mb-4">المحاسب</p>
            <p>..................</p>
        </div>
        <div class="signature-box">
            <p class="mb-4">مدير الفرع</p>
            <p>..................</p>
        </div>
        <div class="signature-box">
            <p class="mb-4">اعتماد الإدارة</p>
            <p>..................</p>
        </div>
    </div>

</div>